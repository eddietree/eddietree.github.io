function getCurrentScene(e){return APP.game.sceneManager.currScene}function GetObj(e){return APP.game.sceneManager.currScene.sceneObjs[e]}function getMeshesUsingMaterial(e,t){function o(e){e instanceof THREE.Mesh&&e.material.name===t&&i.push(e);for(var n=e.children.length-1;n>=0;n-=1)o(e.children[n])}var i=[];return o(e),i}function getMeshByName(e,t){function o(e){if(e.name===t)return e;for(var i=e.children.length-1;i>=0;i-=1){var n=o(e.children[i]);if(null!==n)return n}return null}return o(e)}function LOG(e){console.log(e)}function ASSERT(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}}function v3(e,t,o){return new THREE.Vector3(e,t,o)}function v2(e,t){return new THREE.Vector2(e,t)}function randBetween(e,t){return e+(t-e)*Math.random()}function clamp(e,t,o){return Math.max(e,Math.min(o,t))}function lerp(e,t,o){return e+(t-e)*o}function spherical(e,t,o){var i=Math.sin(t),n=Math.cos(t),a=Math.sin(e),r=Math.cos(e),s=o*r*i,c=o*a*i,d=o*n;return v3(s,d,c)}var APP,RES,SETTINGS;$(window).load(function(){SETTINGS=new Settings,APP=new App,APP.init(),RES=new Resources,RES.load();var e=new Hypercube(!1);e.init(),e.position.copy(v3(0,0,-5)),APP.scene.add(e);var t=SETTINGS.hypercubeInnerCoeff,o=SETTINGS.hypercubeMovementSpeed,i=SETTINGS.hypercubeRadius,n=function(){var e=function(){requestAnimationFrame(e),APP.update(),APP.draw()};APP.startGame(),e()},a=function(){if(SETTINGS.debugForceLoading&&SETTINGS.debug||!RES.isLoadingFinished()){requestAnimationFrame(a),e.update(),APP.update(),APP.draw();var r=RES.getPercentageLoaded();SETTINGS.hypercubeInnerCoeff=lerp(.3,.8,r),SETTINGS.hypercubeMovementSpeed=lerp(1,2.5,r),SETTINGS.hypercubeRadius=lerp(SETTINGS.hypercubeRadius,i,.04);var s=RES.getNumTrackedItems();LOG("Number of tracked items: "+s),LOG("Percent loaded: "+r)}else n(),SETTINGS.hypercubeInnerCoeff=t,SETTINGS.hypercubeMovementSpeed=o,SETTINGS.hypercubeRadius=i,APP.scene.remove(e),e=null};window.addEventListener("resize",function(){APP.onWindowResized()}),a()});var App=function(){};App.prototype={init:function(){this.time=0,this.fps=60,this.dt=1/this.fps,this.mouse=v2(0),this.mousePrev=v2(0),this.mouseRel=v2(0),this.mouseNormalized=v2(-1),this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.z=15,this.renderer=new THREE.WebGLRenderer({canvas:canvas,antialias:SETTINGS.antiAliasing}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(10413022,1),document.body.appendChild(this.renderer.domElement),this.debugObjs=new THREE.Object3D,SETTINGS.debug?(this.gui=new dat.GUI,this.scene.add(this.debugObjs),window.addEventListener("keypress",function(e){(103==e.charCode||119==e.charCode)&&dat.GUI.toggleHide()})):dat.GUI.toggleHide();var e=this;window.addEventListener("mousemove",function(t){var o=t.clientX/window.innerWidth*2-1,i=2*-(t.clientY/window.innerHeight)+1,n=v2(t.clientX,t.clientY);e.mouse=n,e.mouseNormalized=v2(o,i)})},startGame:function(){this.game=new Game,this.game.init(),this.game.start()},update:function(){this.time+=this.dt,TWEEN.update(),this.game&&this.game.update(),this.mouseRel.copy(this.mouse),this.mouseRel.sub(this.mousePrev),this.mousePrev.copy(this.mouse)},draw:function(){this.game&&this.game.draw(),this.renderer.render(this.scene,this.camera)},onWindowResized:function(){this.renderer.setSize(window.innerWidth,window.innerHeight),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()}};var CameraControllerC4D=function(){THREE.Object3D.call(this),this.phi=SETTINGS.cameraC4dPhi,this.theta=SETTINGS.cameraC4dTheta,this.posLookAt=v3(SETTINGS.cameraC4dPosLookAt.x,SETTINGS.cameraC4dPosLookAt.y,SETTINGS.cameraC4dPosLookAt.z),this.mouseState="idle",this.cam=APP.camera};CameraControllerC4D.prototype=Object.create(THREE.Object3D.prototype),CameraControllerC4D.prototype.constructor=CameraControllerC4D,CameraControllerC4D.prototype.init=function(){this.initSettings(),this.initControls()},CameraControllerC4D.prototype.initControls=function(){var e=this;window.addEventListener("mousedown",function(t){if(t.altKey){var o=t.button;0===o&&(e.mouseState="downBtnRotate"),1===o&&(e.mouseState="downBtnPan")}}),window.addEventListener("mouseup",function(t){t.button;e.mouseState="idle"}),window.addEventListener("mousemove",function(t){"idle"!=e.mouseState}),window.addEventListener("wheel",function(e){e.altKey&&(SETTINGS.cameraC4dRadius=clamp(1,100,SETTINGS.cameraC4dRadius+.015*e.deltaY))})},CameraControllerC4D.prototype.initSettings=function(){if(SETTINGS.debug){this.debugStr={posLookAt:"(0,0,0)"};var e=APP.gui.addFolder("Camera C4D");e.add(SETTINGS,"cameraC4dRadius").listen(),e.add(this,"theta").listen(),e.add(this,"phi").listen(),e.add(this.debugStr,"posLookAt").listen();var t=new THREE.SphereGeometry(2,32,32),o=new THREE.MeshBasicMaterial({color:0}),i=new THREE.Mesh(t,o);i.position.copy(this.posLookAt),i.scale.multiplyScalar(.1),this.lookAtSphere=i,APP.debugObjs.add(i)}},CameraControllerC4D.prototype.update=function(){SETTINGS.debug&&(this.debugStr.posLookAt="{x:"+Math.round(100*this.posLookAt.x)/100+", y:"+Math.round(100*this.posLookAt.y)/100+", z:"+Math.round(100*this.posLookAt.z)/100+"}","downBtnRotate"===this.mouseState&&this.updateRotation(),"downBtnPan"===this.mouseState&&this.updatePan(),this.lookAtSphere&&this.lookAtSphere.position.copy(this.posLookAt)),this.updateAutomatic();var e=spherical(this.theta,this.phi,SETTINGS.cameraC4dRadius),t=this.posLookAt.x+e.x,o=this.posLookAt.y+e.y,i=this.posLookAt.z+e.z;this.cam.position.copy(v3(t,o,i)),this.cam.lookAt(this.posLookAt)},CameraControllerC4D.prototype.updateAutomatic=function(){var e=30,t=4e-4,o=-clamp(-e,e,APP.mouseRel.x)*t,i=-clamp(-e,e,APP.mouseRel.y)*t,n=clamp(SETTINGS.cameraC4dTheta-SETTINGS.cameraC4dThetaRange,SETTINGS.cameraC4dTheta+SETTINGS.cameraC4dThetaRange,this.theta+o),a=clamp(SETTINGS.cameraC4dPhi-SETTINGS.cameraC4dPhiRange,SETTINGS.cameraC4dPhi+SETTINGS.cameraC4dPhiRange,this.phi-i);if(this.theta=lerp(this.theta,n,1),this.phi=lerp(this.phi,a,1),Math.abs(o)+Math.abs(i)<1){var r=.015;this.theta=lerp(this.theta,SETTINGS.cameraC4dTheta,r),this.phi=lerp(this.phi,SETTINGS.cameraC4dPhi,r)}},CameraControllerC4D.prototype.updatePan=function(){var e=APP.mouseRel.x,t=APP.mouseRel.y,o=this.cam.quaternion,i=v3(0,1,0).applyQuaternion(o),n=v3(-1,0,0).applyQuaternion(o),a=v2(e*SETTINGS.cameraC4dRadius*.03,t*SETTINGS.cameraC4dRadius*.03),r=i.multiplyScalar(a.y),s=n.multiplyScalar(a.x),c=r.add(s);this.cam.position.add(c),this.posLookAt.add(c)},CameraControllerC4D.prototype.updateRotation=function(){var e=APP.mouseRel.x,t=APP.mouseRel.y;this.theta+=.01*e,this.phi=clamp(this.phi-.01*t,.5*-Math.PI,.5*Math.PI)},CameraControllerC4D.prototype.start=function(){};var Scene=function(){this.sceneObjs={},THREE.Object3D.call(this)};Scene.prototype=Object.create(THREE.Object3D.prototype),Scene.prototype.constructor=Scene,Scene.prototype.init=function(){},Scene.prototype.addSceneObj=function(e,t){this.sceneObjs[e]=t,this.add(t),t.name=e,t.init()},Scene.prototype.update=function(){for(var e in this.sceneObjs){var t=this.sceneObjs[e];t.update()}},Scene.prototype.start=function(){for(var e in this.sceneObjs){var t=this.sceneObjs[e];t.start()}},Scene.prototype.draw=function(){for(var e in this.sceneObjs){var t=this.sceneObjs[e];t.draw()}};var SceneManager=function(e){THREE.Object3D.call(this),this.scenes={}};SceneManager.prototype=Object.create(THREE.Object3D.prototype),SceneManager.prototype.constructor=SceneManager,SceneManager.prototype.addScene=function(e,t){this.scenes[e]=t,t.name=e,t.init()},SceneManager.prototype.changeSceneTo=function(e){LOG("Changing scene to: "+e),null!==this.currScene&&this.remove(this.currScene);var t=this.scenes[e];ASSERT(null!==t),this.currScene=t,this.currScene.start(),this.add(t)},SceneManager.prototype.update=function(){null!==this.currScene&&this.currScene.update()},SceneManager.prototype.draw=function(){null!==this.currScene&&this.currScene.draw()};var SceneObj=function(e){THREE.Object3D.call(this),this.firstName=e};SceneObj.prototype=Object.create(THREE.Object3D.prototype),SceneObj.prototype.constructor=SceneObj,SceneObj.prototype.start=function(){};var Game=function(){};Game.prototype.init=function(){this.sceneManager=new SceneManager,this.sceneManager.addScene("SceneCliff",new SceneCliff),APP.scene.add(this.sceneManager),SETTINGS.debug&&(this.initGui(),this.initDebugGfx()),this.camController=new CameraControllerC4D,this.camController.init()},Game.prototype.initDebugGfx=function(){var e=new THREE.Vector3(0,0,0),t=new THREE.ArrowHelper(v3(1,0,0),e,1,16711680),o=new THREE.ArrowHelper(v3(0,1,0),e,1,65280),i=new THREE.ArrowHelper(v3(0,0,1),e,1,65280);APP.debugObjs.add(t),APP.debugObjs.add(o),APP.debugObjs.add(i);for(var n=new THREE.Geometry,a=100,r=5,s=-a;a>=s;s+=r)n.vertices.push(v3(s,0,-a)),n.vertices.push(v3(s,0,+a)),n.vertices.push(v3(-a,0,s)),n.vertices.push(v3(+a,0,s));var c=new THREE.LineBasicMaterial({color:16777215});c.transparent=!0,c.opacity=.25;var d=new THREE.LineSegments(n,c);APP.debugObjs.add(d)},Game.prototype.initGui=function(){APP.gui.add(SETTINGS,"showDebugObjects"),this.debugStr={cameraPos:"(0,0,0)"};var e=APP.gui.addFolder("Camera");e.add(SETTINGS,"cameraFOV",0,180),e.add(this.debugStr,"cameraPos").listen()},Game.prototype.start=function(){APP.camera.fov=SETTINGS.cameraFOV,APP.camera.updateProjectionMatrix(),APP.camera.position.x=SETTINGS.cameraStartPos.x,APP.camera.position.y=SETTINGS.cameraStartPos.y,APP.camera.position.z=SETTINGS.cameraStartPos.z,this.sceneManager.changeSceneTo("SceneCliff"),SETTINGS.mute&&Howler.mute(),$("#mutebtn").click(function(){SETTINGS.mute=!SETTINGS.mute,SETTINGS.mute?Howler.mute():Howler.unmute()})},Game.prototype.update=function(){SETTINGS.debug&&(APP.debugObjs.visible=SETTINGS.showDebugObjects,this.debugStr.cameraPos="{x:"+Math.round(100*APP.camera.position.x)/100+", y:"+Math.round(100*APP.camera.position.y)/100+", z:"+Math.round(100*APP.camera.position.z)/100+"}"),APP.camera.fov!=SETTINGS.cameraFOV&&(APP.camera.fov=SETTINGS.cameraFOV,APP.camera.updateProjectionMatrix()),this.camController&&this.camController.update(),this.sceneManager.update()},Game.prototype.draw=function(){this.sceneManager.draw()};var Resources=function(){this.defTextures={"perlin.png":{},"particle.png":{}},this.defModels={"cliff.dae":{}},this.defJSON=["Settings.json"],this.defAudio={lull:{urls:["resource/audio/lull.ogg"],filesize:1085e3,volume:1,loop:!0},vex:{urls:["resource/audio/vex.ogg"],filesize:914e3,volume:1,loop:!0},ping:{urls:["resource/audio/ping.ogg"],filesize:7e3,volume:.75,loop:!1},charging:{urls:["resource/audio/charging.ogg"],filesize:81e3,volume:.1,loop:!0}},this.defShaders=["basic.vp","basic.fp","diamond.vp","diamond.fp","snow.vp","snow.fp","snowParticles.vp","snowParticles.fp","vignette.vp","vignette.fp","sunShaft.vp","sunShaft.fp","ribbons.vp","ribbons.fp"],this.shaders={},this.models={},this.textures={},this.audio={},this.json={},this.loadingTrackedItems=[]};Resources.prototype.load=function(){this.loadJSON(),this.loadTextures(),this.loadModels(),this.loadAudio(),this.loadShaders()},Resources.prototype.getPercentageLoaded=function(){for(var e=0,t=0,o=0;o<this.loadingTrackedItems.length;o+=1){var i=this.loadingTrackedItems[o];e+=i.loadedBytes,t+=i.totalSizeBytes}return 0===t?0:e/t},Resources.prototype.getNumTrackedItems=function(){return this.loadingTrackedItems.length},Resources.prototype.isLoadingFinished=function(){if(0===this.loadingTrackedItems.length)return!0;for(var e=0,t=0,o=0;o<this.loadingTrackedItems.length;o+=1){var i=this.loadingTrackedItems[o];e+=i.loadedBytes,t+=i.totalSizeBytes}return 0===t?!1:e==t},Resources.prototype.loadTextures=function(){LOG("Loading Textures");var e=this.defTextures;for(var t in e){e[t];this.loadTexture(t)}},Resources.prototype.loadTexture=function(e){var t=this,o="resource/tex/"+e,i={loadedBytes:0,totalSizeBytes:16384};this.loadingTrackedItems[this.loadingTrackedItems.length]=i;var n=new THREE.TextureLoader;n.load(o,function(n){LOG("Loaded Texture file: "+o),i.loadedBytes=i.totalSizeBytes,t.textures[e]=n},function(t){i.loadedBytes=t.loaded,i.totalSizeBytes=t.total,LOG(t.loaded/t.total*100+"% loaded: "+e)},function(e){LOG("ERROR loading Texture file: "+o)})},Resources.prototype.loadModels=function(){LOG("Loading models");var e=this.defModels;for(var t in e){var o=(e[t],t);this.loadModel(o)}},Resources.prototype.loadModel=function(e){var t=this,o="resource/obj/"+e,i={loadedBytes:0,totalSizeBytes:16384};this.loadingTrackedItems[this.loadingTrackedItems.length]=i;var n=new THREE.ColladaLoader;n.load(o,function(n){LOG("Loaded Collada file: "+o),i.loadedBytes=i.totalSizeBytes,t.models[e]=n.scene},function(e){i.loadedBytes=e.loaded,i.totalSizeBytes=e.total,LOG(e.loaded/e.total*100+"% loaded")},function(e){LOG("ERROR loading Collada file: "+o),LOG(e.loaded/e.total*100+"% loaded")})},Resources.prototype.loadJSON=function(){var e=this.defJSON,t=this;e.forEach(function(e){var o="resource/json/"+e,i={loadedBytes:0,totalSizeBytes:512};t.loadingTrackedItems[t.loadingTrackedItems.length]=i,$.getJSON(o,function(o){i.loadedBytes=i.totalSizeBytes,LOG("Loaded JSON file: "+e),t.json[e]=o})})},Resources.prototype.loadAudioDef=function(e){var t=this,o=this.defAudio,i=o[e],n={loadedBytes:0,totalSizeBytes:i.filesize};t.loadingTrackedItems[t.loadingTrackedItems.length]=n,LOG(i);var a=new Howl({urls:i.urls,autoplay:!1,loop:void 0===i.loop?!1:i.loop,volume:i.volume,onload:function(){n.loadedBytes=n.totalSizeBytes,t.audio[e]=a,LOG("Loaded audio file: "+e),LOG(a)}})},Resources.prototype.loadAudio=function(){var e=this.defAudio;for(var t in e)this.loadAudioDef(t)},Resources.prototype.loadShaders=function(){var e=this.defShaders,t=this;e.forEach(function(e){function o(o){a.loadedBytes=a.totalSizeBytes,LOG("Loaded shader: "+n),t.shaders[e]=r.responseText}function i(e){LOG("Error loading shader: "+n)}var n="resource/shaders/"+e,a={loadedBytes:0,totalSizeBytes:1024};t.loadingTrackedItems[t.loadingTrackedItems.length]=a;var r=new XMLHttpRequest;r.overrideMimeType&&r.overrideMimeType("text/plain"),r.open("get",n,!0),r.addEventListener("load",o,!1),r.addEventListener("error",i,!1),r.send()})};var Settings=function(){return{debug:!1,debugForceLoading:!1,showDebugObjects:!1,antiAliasing:!0,cameraFOV:50,cameraStartPos:{x:6.82,y:2.1,z:36.95},cameraC4dRadius:35,cameraC4dRadiusIntro:70,cameraC4dTheta:7.7,cameraC4dPhi:1.5,cameraC4dPosLookAt:{x:2.93,y:.95,z:-.33},cameraC4dThetaRange:.3,cameraC4dPhiRange:.3,fogEnabled:!0,fogDensity:.0165,mute:!1,fadeAlpha:0,fadeColor:16777215,fadeColorDark:16777215,sunshaftAlpha:.2,sunshaftAlphaDark:.2,vignetteAlpha:.3,vignetteAlphaDark:.5,vignetteRadius:.4,vignetteRadiusDark:0,ribbonAlpha:1,ribbonAlphaDark:-.5,snowSpeed:2,snowSpeedDark:1,snowHeightCoeff:1,snowHeightCoeffDark:5,snowColor:16777215,snowColorDark:0,snowParticleColor:16777215,snowParticleColorDark:2436166,snowParticleBounds:{x:100,y:40,z:30},snowParticleDiameter:20,snowParticleDiameterDark:45,snowParticleWindSpeed:1,snowParticleWindSpeedDark:.8,snowParticleWindDir:{x:-1.5,y:-1,z:0},snowParticleWindDirDark:{x:0,y:1,z:0},mainLightIntensity:2,mainLightIntensityDark:5,mainLightDistance:27,mainLightDistanceDark:6,hypercubeRadius:1.6,hypercubeInnerCoeff:.65,hypercubeMovementSpeed:.95,ambientLightColor:9867707,ambientLightColorDark:3158324,clearColor:10413022,clearColorDark:5127780}},Diamond=function(e){LOG("Creating Diamond"),SceneObj.call(this),this.add(e);var t=e.children[0];this.material=new THREE.ShaderMaterial({vertexShader:RES.shaders["diamond.vp"],fragmentShader:RES.shaders["diamond.fp"]}),t.material=this.material};Diamond.prototype=Object.create(SceneObj.prototype),Diamond.prototype.constructor=Diamond,Diamond.prototype.init=function(){},Diamond.prototype.start=function(){},Diamond.prototype.update=function(){this.position.copy(v3(5,5,0)),this.rotation.set(0,.5*APP.time,0,"XYZ")},Diamond.prototype.draw=function(){};var Human=function(e){SceneObj.call(this),LOG("Creating Human")};Human.prototype=Object.create(SceneObj.prototype),Human.prototype.constructor=Human,Human.prototype.init=function(){var e=RES.models["cliff.dae"],t=getMeshesUsingMaterial(e,"Body");LOG(t.length+" meshes found with 'Body' material"),t.forEach(function(e){}),this.meshesBody=t},Human.prototype.start=function(){},Human.prototype.update=function(){},Human.prototype.draw=function(){};var Hypercube=function(e){SceneObj.call(this),LOG("Creating Hypercube"),this.numTheta=4,this.edgePos=[],this.doRaycast=void 0===e?!0:e,this.isHovering=!1,this.hoverLerped=0,this.tweenClick=null};Hypercube.prototype=Object.create(SceneObj.prototype),Hypercube.prototype.constructor=Hypercube,Hypercube.prototype.init=function(){this.position.copy(v3(2.6,4.1,0)),this.rotation.set(.5*Math.PI,0,0,"XYZ"),this.initGeo(),this.initRaycastGeo(),this.raycaster=new THREE.Raycaster;var e=new THREE.SphereGeometry(.4,4,1),t=new THREE.MeshBasicMaterial({color:16777215}),o=new THREE.Mesh(e,t);this.innerSphere=o,this.add(o);var i=this;if(SETTINGS.debug&&this.doRaycast){var n=APP.gui.addFolder("Hypercube");n.add(SETTINGS,"hypercubeRadius",0,10).listen(),n.add(SETTINGS,"hypercubeInnerCoeff",0,1).listen(),n.add(SETTINGS,"hypercubeMovementSpeed",0,1).listen()}this.doRaycast&&(this.sndCharging=RES.audio.charging,window.addEventListener("mousedown",function(e){e.altKey||0==e.button&&i.isHovering&&i.onClicked()}))},Hypercube.prototype.initGeo=function(){function e(e,t){return e=(a+e)%a,t=(n+t)%n,e*n+t}for(var t=[],o=[],i=[],n=4,a=this.numTheta,r=2*Math.PI/this.numTheta,s=1,c=0;c<this.numTheta;c+=1){var d=c*r,h=.5*Math.PI,l=spherical(d,h,s),u=l,p=spherical(d,h+.5*Math.PI,s);t.push(l),o.push(u),i.push(p)}this.edgeCenters=t,this.edgeDirX=o,this.edgeDirY=i;for(var S=new THREE.Geometry,T=new THREE.Geometry,f=0;f<this.numTheta*n;f+=1){for(iRing=0;iRing<n;iRing+=1)S.vertices.push(v3(0,0,0));this.edgePos.push(v3(0)),T.vertices.push(v3(0,0,0))}for(var c=0;c<this.numTheta;c+=1){for(iRing=0;iRing<n;iRing+=1){var E=e(c,iRing),m=e(c+1,iRing),g=e(c+1,iRing+1),v=e(c,iRing+1),y=new THREE.Color,w=new THREE.Color,b=new THREE.Color,C=new THREE.Color;y.setHSL(randBetween(0,1),1,randBetween(.6,.8)),w.setHSL(randBetween(0,1),1,randBetween(.6,.8)),b.setHSL(randBetween(0,1),1,randBetween(.6,.8)),C.setHSL(randBetween(0,1),1,randBetween(.6,.8));var R=new THREE.Face3(E,m,g),G=new THREE.Face3(E,g,v);R.vertexColors[0]=y,R.vertexColors[1]=w,R.vertexColors[2]=b,G.vertexColors[0]=y,G.vertexColors[1]=b,G.vertexColors[2]=C,T.faces.push(R),T.faces.push(G)}var E=e(c,iRing),m=e(c,iRing+1),g=e(c,iRing+2),v=e(c,iRing+3),y=new THREE.Color,w=new THREE.Color,b=new THREE.Color,C=new THREE.Color;y.setHSL(randBetween(0,1),1,randBetween(.5,1)),w.setHSL(randBetween(0,1),1,randBetween(.5,1)),b.setHSL(randBetween(0,1),1,randBetween(.5,1)),C.setHSL(randBetween(0,1),1,randBetween(.5,1));var R=new THREE.Face3(E,m,g),G=new THREE.Face3(E,g,v);R.vertexColors[0]=y,R.vertexColors[1]=w,R.vertexColors[2]=b,G.vertexColors[0]=y,G.vertexColors[1]=b,G.vertexColors[2]=C,T.faces.push(R),T.faces.push(G)}var P=new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors});this.materialTris=P,this.materialTris.transparent=!0,this.materialTris.opacity=.5,this.materialTris.side=THREE.DoubleSide,this.materialTris.depthWrite=!1,this.meshTris=new THREE.Mesh(T,P),this.meshTris.renderOrder=1,this.add(this.meshTris);var I=new THREE.LineBasicMaterial({color:16777215});this.meshLines=new THREE.LineSegments(S,I),this.add(this.meshLines)},Hypercube.prototype.initRaycastGeo=function(){var e=new THREE.BoxGeometry(3.6,2,3.6),t=new THREE.MeshBasicMaterial({color:16711680});t.transparent=!0,t.opacity=0,t.depthTest=!1,t.depthWrite=!1;var o=new THREE.Mesh(e,t);o.rotation.set(0,.25*Math.PI,0,"XYZ"),this.collisionSphere=o,this.add(o)},Hypercube.prototype.updateVertPositions=function(){for(var e=SETTINGS.hypercubeRadius,t=e*SETTINGS.hypercubeInnerCoeff,o=APP.time*SETTINGS.hypercubeMovementSpeed,i=4,n=2*Math.PI/i,a=0;a<this.edgeCenters.length;a+=1)for(var r=this.edgeCenters[a].clone().multiplyScalar(e),s=this.edgeDirX[a],c=this.edgeDirY[a],d=0;i>d;d+=1){var h=o+d*n,l=Math.cos(h),u=Math.sin(h),p=s.clone(),S=c.clone();p.multiplyScalar(l*t),S.multiplyScalar(u*t);var T=p.clone();T.add(S),T.add(r),this.edgePos[a*i+d].copy(T)}},Hypercube.prototype.sendToGPU=function(){function e(e,t){return 4*e+t}for(var t=this.meshLines.geometry.vertices,o=this.meshTris.geometry.vertices,i=this.edgePos,n=0,a=4,r=this.numTheta,s=0;s<i.length;s+=1)o[s].copy(i[s]);for(var c=0;r>c;c+=1)for(var d=c,h=(d+1)%r,l=(r+c-1)%r,u=0;a>u;u+=1){var p=e(d,u),S=e(h,u),T=e(l,u),f=e(d,(u+1)%a);t[n]=i[p],n+=1,t[n]=i[S],n+=1,t[n]=i[p],n+=1,t[n]=i[T],n+=1,t[n]=i[p],n+=1,t[n]=i[f],n+=1}this.meshLines.geometry.verticesNeedUpdate=!0,this.meshTris.geometry.verticesNeedUpdate=!0},Hypercube.prototype.update=function(){this.updateVertPositions(),this.sendToGPU();this.materialTris.uniforms;this.doRaycast&&this.updateRaycasts()},Hypercube.prototype.onBeginHover=function(){$("#canvas").css("cursor","pointer"),this.sndCharging.play()},Hypercube.prototype.onEndHover=function(){$("#canvas").css("cursor","default"),this.sndCharging.stop()},Hypercube.prototype.onClicked=function(){LOG("Clicked on Hypercube!"),this.isHovering=!1,this.sndCharging.stop(),GetObj("LightDark").onToggle(),null!==this.tweenClick&&this.tweenClick.stop();var e=4;this.position.setY(e+6),this.tweenClick=new TWEEN.Tween(this.position).to({y:e},800).easing(TWEEN.Easing.Elastic.Out).start(),this.hoverLerped=0},Hypercube.prototype.updateRaycasts=function(){this.raycaster.setFromCamera(APP.mouseNormalized,APP.camera);var e=this.raycaster.intersectObject(this.collisionSphere,!0),t=e.length>0;this.isHovering&&!t?(this.onEndHover(),this.isHovering=t):!this.isHovering&&t&&(this.onBeginHover(),this.isHovering=t),this.hoverLerped=lerp(this.hoverLerped,this.isHovering?1:0,this.isHovering?.15:.06);var o=lerp(1,1.8,this.hoverLerped);this.scale.set(o,o,o);var i=GetObj("LightDark").state,n="LIGHT"===i?1-this.hoverLerped:this.hoverLerped;this.innerSphere.material.color.setRGB(n,n,n),APP.time+=2.5*this.hoverLerped*APP.dt},Hypercube.prototype.draw=function(){};var LightDark=function(e){SceneObj.call(this),LOG("Creating LightDark"),this.state="LIGHT"};LightDark.prototype=Object.create(SceneObj.prototype),LightDark.prototype.constructor=LightDark,LightDark.prototype.init=function(){if(SETTINGS.debug){APP.gui.addFolder("LightDark")}this.sndLoopLight=RES.audio.lull,this.sndLoopDark=RES.audio.vex,this.sndPing=RES.audio.ping,this.snowCliff=getMeshByName(RES.models["cliff.dae"],"IceCliff"),this.human=getMeshByName(RES.models["cliff.dae"],"Human")},LightDark.prototype.start=function(){this.sndLoopLight.play(),this.sndLoopLight.fade(0,1,2e3)},LightDark.prototype.update=function(){},LightDark.prototype.draw=function(){},LightDark.prototype.enableModeLight=function(){this.state="LIGHT",LOG("LIGHT ON"),this.toggleLightDark(),this.sndLoopDark.stop(),this.sndLoopLight.play()},LightDark.prototype.enableModeDark=function(){this.state="DARK",LOG("DARK ON"),this.toggleLightDark(),this.sndLoopDark.play(),this.sndLoopLight.stop()},LightDark.prototype.toggleLightDark=function(){this.sndPing.play();var e="Dark";for(var t in SETTINGS){var o=t+e;if(!t.contains(e)&&SETTINGS.hasOwnProperty(o)){SETTINGS.debug&&LOG(t+" : "+SETTINGS[t]);var i=SETTINGS[t];SETTINGS[t]=SETTINGS[o],SETTINGS[o]=i}}},LightDark.prototype.onToggle=function(){LOG("LightDark.onToggle()"),"LIGHT"===this.state?this.enableModeDark():"DARK"===this.state&&this.enableModeLight(),SETTINGS.fadeAlpha=1};var Ribbons=function(e){SceneObj.call(this),LOG("Creating Ribbons")};Ribbons.prototype=Object.create(SceneObj.prototype),Ribbons.prototype.constructor=Ribbons,Ribbons.prototype.init=function(){if(this.initGeo(),SETTINGS.debug){APP.gui.addFolder("Ribbons")}},Ribbons.prototype.initGeo=function(){var e=new THREE.SphereGeometry(120,32,32),t=new THREE.ShaderMaterial({vertexShader:RES.shaders["ribbons.vp"],fragmentShader:RES.shaders["ribbons.fp"],uniforms:{uTime:{type:"f",value:0},uAlpha:{type:"f",value:SETTINGS.ribbonAlpha},uColorSky:{type:"v3",value:v3(SETTINGS.clearColor)}}});t.side=THREE.BackSide;var o=new THREE.Mesh(e,t);this.material=t,this.add(o)},Ribbons.prototype.start=function(){},Ribbons.prototype.update=function(){var e=new THREE.Color(SETTINGS.clearColor);e=v3(e.r,e.g,e.b);var t=this.material.uniforms;t.uTime.value=APP.time,t.uColorSky.value=e,t.uAlpha.value=SETTINGS.ribbonAlpha},Ribbons.prototype.draw=function(){};var SceneCliff=function(e){Scene.call(this)};SceneCliff.prototype=Object.create(Scene.prototype),SceneCliff.prototype.constructor=SceneCliff,SceneCliff.prototype.init=function(){Scene.prototype.init.call(this),this.parseSceneCollada(),this.addSceneObj("LightDark",new LightDark),this.addSceneObj("SnowParticles",new SnowParticles),this.addSceneObj("SnowObjects",new SnowObjects),this.addSceneObj("Vignette",new Vignette),this.addSceneObj("SunShaft",new SunShaft),this.addSceneObj("Human",new Human),this.addSceneObj("Ribbons",new Ribbons),this.addSceneObj("Hypercube",new Hypercube),this.ambientLight=new THREE.AmbientLight(SETTINGS.ambientLightColor),this.add(this.ambientLight),APP.renderer.setClearColor(SETTINGS.clearColor,1),SETTINGS.fogEnabled&&(APP.scene.fog=new THREE.FogExp2(SETTINGS.clearColor,.03)),SETTINGS.debug&&this.initGui()},SceneCliff.prototype.initGui=function(){var e=APP.gui.addFolder("Environment");e.addColor(SETTINGS,"ambientLightColor").listen(),e.addColor(SETTINGS,"clearColor").listen(),e.addColor(SETTINGS,"snowColor").listen(),e.addColor(SETTINGS,"snowParticleColor").listen(),APP.scene.fog&&e.add(SETTINGS,"fogDensity",.01,.1).listen()},SceneCliff.prototype.onLoadObject=function(e){String.prototype.contains=function(e){return-1!=this.indexOf(e)};var t=e.name;if(t.contains("Diamond"))this.addSceneObj("Diamond",new Diamond(e));else if(t.contains("Light")){var o=e.children[0];o.intensity=2,o.distance=27,null===this.mainLight&&(this.mainLight=o);var i=new THREE.SphereGeometry(5,32,32),n=new THREE.MeshBasicMaterial({color:o.color}),a=new THREE.Mesh(i,n);a.position.copy(e.position),a.scale.multiplyScalar(.1),APP.debugObjs.add(a)}else t.contains("Cliff")||t.contains("TreeTop")},SceneCliff.prototype.parseSceneCollada=function(){function e(o){if("Ignore"!=o.name){t.onLoadObject(o);for(var i=o.children.length-1;i>=0;i-=1)e(o.children[i])}}for(var t=this,o=RES.models["cliff.dae"],i=0;i<o.children.length;i+=1)if("Ignore"===o.children[i].name){o.remove(o.children[i]);break}this.add(o),e(o),SETTINGS.debug&&(LOG("Collada File:"),LOG(o));var n=getMeshesUsingMaterial(o,"Face"),a=n[0];a.material=new THREE.MeshBasicMaterial({color:16777215})},SceneCliff.prototype.update=function(){APP.renderer.setClearColor(SETTINGS.clearColor,1),this.ambientLight.color.setHex(SETTINGS.ambientLightColor),APP.scene.fog&&(APP.scene.fog.density=SETTINGS.fogDensity,APP.scene.fog.color.setHex(SETTINGS.clearColor)),this.updateObjs(),Scene.prototype.update.call(this)},SceneCliff.prototype.updateObjs=function(){this.mainLight&&(this.mainLight.intensity=SETTINGS.mainLightIntensity,this.mainLight.distance=SETTINGS.mainLightDistance)},SceneCliff.prototype.start=function(){LOG("SceneCliff.start()"),Scene.prototype.start.call(this),SETTINGS.fadeAlpha=1;var e=SETTINGS.cameraC4dRadius;SETTINGS.cameraC4dRadius=SETTINGS.cameraC4dRadiusIntro;new TWEEN.Tween(SETTINGS).to({cameraC4dRadius:e},3500).easing(TWEEN.Easing.Cubic.Out).start()};var SnowObjects=function(e){SceneObj.call(this),LOG("Creating SnowObjects")};SnowObjects.prototype=Object.create(SceneObj.prototype),SnowObjects.prototype.constructor=SnowObjects,SnowObjects.prototype.init=function(){var e=RES.models["cliff.dae"],t=getMeshesUsingMaterial(e,"Snow");if(LOG(t.length+" meshes found with 'Snow' material"),t.forEach(function(e){e.material=new THREE.ShaderMaterial({vertexShader:RES.shaders["snow.vp"],fragmentShader:RES.shaders["snow.fp"],uniforms:{uTime:{type:"f",value:0},uPhongCoeff:{type:"f",value:1},uMoveDelta:{type:"f",value:1},uColorSnow:{type:"v3",value:v3(SETTINGS.snowColor)},uColorSky:{type:"v3",value:v3(SETTINGS.clearColor)}}})}),this.meshesSnow=t,this.colorSky=new THREE.Color(SETTINGS.clearColor),this.colorSnow=new THREE.Color(SETTINGS.clearColor),SETTINGS.debug){var o=APP.gui.addFolder("Snow Objects");o.add(SETTINGS,"snowSpeed"),o.add(SETTINGS,"snowHeightCoeff",0,10)}},SnowObjects.prototype.start=function(){},SnowObjects.prototype.update=function(){var e=APP.time*SETTINGS.snowSpeed,t=new THREE.Color(SETTINGS.clearColor);t=v3(t.r,t.g,t.b),this.colorSnow.setHex(SETTINGS.snowColor);var o=this,i="LIGHT"===GetObj("LightDark").state;this.meshesSnow.forEach(function(n){var a=t,r=1,s=SETTINGS.snowHeightCoeff;"CliffTop"===n.parent.name?s=.12:n.parent.name.contains("TreeSnow")&&(s=.02,r=i?0:1,a.lerp(t,.45));var c=n.material;c.uniforms.uTime.value=e,c.uniforms.uColorSky.value=a,c.uniforms.uColorSnow.value=v3(o.colorSnow.r,o.colorSnow.g,o.colorSnow.b),c.uniforms.uMoveDelta.value=s,c.uniforms.uPhongCoeff.value=r})},SnowObjects.prototype.draw=function(){};var SnowParticles=function(e){SceneObj.call(this),LOG("Creating SnowParticles")};SnowParticles.prototype=Object.create(SceneObj.prototype),SnowParticles.prototype.constructor=SnowParticles,SnowParticles.prototype.init=function(){var e=function(){for(var e=3e3,t=v3(SETTINGS.snowParticleBounds.x,SETTINGS.snowParticleBounds.y,SETTINGS.snowParticleBounds.z),o=new THREE.Geometry,i=0;e>i;i+=1){var n=randBetween(-t.x,t.x),a=randBetween(-t.y,t.y),r=randBetween(-t.z,t.z);o.vertices.push(v3(n,a,r))}var s=RES.textures["particle.png"],c=new THREE.ShaderMaterial({vertexShader:RES.shaders["snowParticles.vp"],fragmentShader:RES.shaders["snowParticles.fp"],uniforms:{uTime:{type:"f",value:0},uColorSnow:{type:"v3",value:v3(SETTINGS.snowParticleColor)},uColorSky:{type:"v3",value:v3(SETTINGS.clearColor)},uBounds:{type:"v3",value:t},uWindDir:{type:"v3",value:v3(SETTINGS.snowParticleWindDir.x,SETTINGS.snowParticleWindDir.y,SETTINGS.snowParticleWindDir.z)},uTex:{type:"t",value:s},uParticleRadius:{type:"f",value:SETTINGS.snowParticleDiameter}}});c.transparent=!0,c.depthWrite=!1;var d=new THREE.Points(o,c);this.material=c,this.colorSky=new THREE.Color(SETTINGS.clearColor),this.colorSnow=new THREE.Color(SETTINGS.clearColor),this.add(d)};e.call(this)},SnowParticles.prototype.start=function(){},SnowParticles.prototype.update=function(){this.colorSky.setHex(SETTINGS.clearColor),this.colorSnow.setHex(SETTINGS.snowParticleColor);var e=this.material.uniforms;e.uTime.value=APP.time*SETTINGS.snowParticleWindSpeed,e.uColorSky.value.set(this.colorSky.r,this.colorSky.g,this.colorSky.b),e.uColorSnow.value.set(this.colorSnow.r,this.colorSnow.g,this.colorSnow.b),e.uParticleRadius.value=SETTINGS.snowParticleDiameter,e.uWindDir.value=v3(SETTINGS.snowParticleWindDir.x,SETTINGS.snowParticleWindDir.y,SETTINGS.snowParticleWindDir.z)},SnowParticles.prototype.draw=function(){};var SunShaft=function(e){SceneObj.call(this),LOG("Creating SunShaft")};SunShaft.prototype=Object.create(SceneObj.prototype),SunShaft.prototype.constructor=SunShaft,SunShaft.prototype.init=function(){if(this.initGeo(),SETTINGS.debug){APP.gui.addFolder("SunShaft")}},SunShaft.prototype.initGeo=function(){for(var e=new THREE.Geometry,t=2,o=(v3(0),0);t>o;o+=1){var i=randBetween(-1,1);e.vertices.push(v3(0,0,i)),e.vertices.push(v3(1,0,i)),e.vertices.push(v3(1,1,i)),e.vertices.push(v3(0,1,i));var n=4*o,a=n+0,r=n+1,s=n+2,c=n+3,d=v3(randBetween(0,1),randBetween(0,1),randBetween(0,1));e.faces.push(new THREE.Face3(a,r,s,d)),e.faces.push(new THREE.Face3(a,s,c,d))}var h=RES.textures["perlin.png"];h.wrapS=h.wrapT=THREE.RepeatWrapping;var l=new THREE.ShaderMaterial({vertexShader:RES.shaders["sunShaft.vp"],fragmentShader:RES.shaders["sunShaft.fp"],uniforms:{uTime:{type:"f",value:0},uShaftAlpha:{type:"f",value:SETTINGS.sunshaftAlpha},uTex:{type:"t",value:h}}});l.depthTest=!1,l.transparent=!0,l.blending=THREE.AdditiveBlending;var u=new THREE.Mesh(e,l);
this.material=l,this.add(u)},SunShaft.prototype.start=function(){},SunShaft.prototype.update=function(){var e=this.material.uniforms;e.uTime.value=APP.time,e.uShaftAlpha.value=SETTINGS.sunshaftAlpha},SunShaft.prototype.draw=function(){};var TestBox=function(e){SceneObj.call(this),LOG("Creating TestBox")};TestBox.prototype=Object.create(SceneObj.prototype),TestBox.prototype.constructor=TestBox,TestBox.prototype.init=function(){var e=new THREE.BoxGeometry(1,1,1),t=new THREE.MeshBasicMaterial({color:new THREE.Color(16711935)});this.cube=new THREE.Mesh(e,t);new THREE.BoxGeometry(1,1,1),new THREE.MeshBasicMaterial({color:new THREE.Color(16711935)});this.cube2=new THREE.Mesh(e,t),this.cube2.position.x=1,this.cube2.position.y=1,this.cube2.position.z=1,this.cube.add(this.cube2),this.add(this.cube),this.initLight()},TestBox.prototype.initLight=function(){var e=new THREE.SpotLight(16777215);e.position.set(2,2,0),APP.scene.add(e);var t=new THREE.SpotLightHelper(e);APP.scene.add(t);var o=new THREE.AmbientLight(4473924);APP.scene.add(o)},TestBox.prototype.start=function(){new TWEEN.Tween(this.cube.position).to({x:1,y:1,z:1},500).easing(TWEEN.Easing.Back.In).start()},TestBox.prototype.update=function(){},TestBox.prototype.draw=function(){};var Vignette=function(e){SceneObj.call(this),LOG("Creating Vignette"),this.fadeColor=new THREE.Color(SETTINGS.fadeColor)};Vignette.prototype=Object.create(SceneObj.prototype),Vignette.prototype.constructor=Vignette,Vignette.prototype.init=function(){if(this.initGeo(),SETTINGS.debug){var e=APP.gui.addFolder("Vignette");e.add(SETTINGS,"vignetteAlpha",0,1),e.add(SETTINGS,"vignetteRadius",0,1)}},Vignette.prototype.initGeo=function(){var e=new THREE.Geometry;e.vertices.push(v3(0,0,0)),e.vertices.push(v3(1,0,0)),e.vertices.push(v3(1,1,0)),e.vertices.push(v3(0,1,0)),e.faces.push(new THREE.Face3(0,1,2)),e.faces.push(new THREE.Face3(0,2,3));var t=new THREE.ShaderMaterial({vertexShader:RES.shaders["vignette.vp"],fragmentShader:RES.shaders["vignette.fp"],uniforms:{uVignetteAlpha:{type:"f",value:SETTINGS.vignetteAlpha},uVignetteRadius:{type:"f",value:SETTINGS.vignetteRadius},uFadeAlpha:{type:"f",value:SETTINGS.fadeAlpha},uFadeColor:{type:"v3",value:v3(0)}}});t.depthTest=!1,t.transparent=!0;var o=new THREE.Mesh(e,t);o.renderOrder=100,o.frustumCulled=!1,this.material=t,this.add(o)},Vignette.prototype.start=function(){},Vignette.prototype.update=function(){var e=this.material.uniforms;SETTINGS.fadeAlpha=lerp(SETTINGS.fadeAlpha,0,.025),this.fadeColor.setHex(SETTINGS.fadeColor),e.uVignetteAlpha.value=SETTINGS.vignetteAlpha,e.uVignetteRadius.value=SETTINGS.vignetteRadius,e.uFadeAlpha.value=SETTINGS.fadeAlpha,e.uFadeColor.value.set(this.fadeColor.r,this.fadeColor.g,this.fadeColor.b)},Vignette.prototype.draw=function(){};